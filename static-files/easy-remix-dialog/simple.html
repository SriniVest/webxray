<!DOCTYPE html>
<meta charset="utf-8">
<title>Simple Easy Remix</title>
<link rel="stylesheet" href="../codemirror2/lib/codemirror.css">
<link rel="stylesheet" href="../dialog-common/stylesheets/jsbin-codemirror-theme.css">
<style>
html, body {
  height: 100%;
  margin: 0px;
  padding: 0px;
}

div.editor {
  width: 100%;
  height: 100%;
  padding: 10px;
  -moz-box-sizing: border-box;
}

.CodeMirror {
  width: 100%;
  height: 100%;
  border: 1px solid black;
  background: rgba(255, 255, 255, 0.95);
  font-family: Monaco, monospace;
  font-size: 11px;
  -moz-box-sizing: border-box;
}

.CodeMirror-scroll {
  height: 100%;
}
</style>
<div class="editor"></div>
<script src="../codemirror2/lib/codemirror.js"></script>
<script src="../codemirror2/mode/xml/xml.js"></script>
<script src="../codemirror2/mode/javascript/javascript.js"></script>
<script src="../codemirror2/mode/css/css.js"></script>
<script src="../codemirror2/mode/htmlmixed/htmlmixed.js"></script>
<script src="../jquery.min.js"></script>
<script>
var parentWindow = (top != window && top);
var editor = null;

function sendContent() {
  var content = editor.getValue();
  parentWindow.postMessage(JSON.stringify({
    currentHTML: content
  }), "*");
}

function onMessage(event) {
  var data = JSON.parse(event.data);
  if (data.startHTML) {
    editor.setValue(data.startHTML);
    editor.focus();
  }
}

onmessage = onMessage;

$(window).ready(function() {
  var DELAY_MS = 300;
  var delay = null;

  editor = CodeMirror(function(element) {
    $(".editor").append(element);
  }, {
    mode: "text/html",
    theme: "jsbin",
    tabMode: "indent",
    lineWrapping: true,
    onChange: function() {
      clearTimeout(delay);
      setTimeout(sendContent, DELAY_MS);      
    }
  });

  if (!parentWindow) {
    parentWindow = {
      postMessage: function(content, target) {
        console.log("POSTMESSAGE", content, target);
      }      
    };
    onMessage({
      data: JSON.stringify({startHTML: "<p>hi</p>"}),
      source: parentWindow
    });
  }
});
</script>
